<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Programma Giornaliero Trasformazione Frutta - Simone Gatto</title>
<!-- Importazione librerie esterne -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
 body {
     font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
     background-color: #f8f9fa;
     padding: 20px;
 }
 
 .main-header {
     background: linear-gradient(135deg, #1e3c72, #2a5298);
     color: white;
     padding: 30px;
     border-radius: 15px;
     text-align: center;
     margin-bottom: 30px;
     box-shadow: 0 8px 25px rgba(0,0,0,0.15);
 }
 
 .section-card {
     background: white;
     border-radius: 12px;
     padding: 25px;
     margin-bottom: 25px;
     box-shadow: 0 4px 15px rgba(0,0,0,0.08);
     border-left: 4px solid #2a5298;
 }
 
 .section-title {
     color: #1e3c72;
     font-weight: 600;
     margin-bottom: 20px;
     padding-bottom: 10px;
     border-bottom: 2px solid #e9ecef;
 }
 
 .form-label {
     font-weight: 600;
     color: #495057;
     margin-bottom: 8px;
 }
 
 .form-control, .form-select {
     border-radius: 8px;
     border: 2px solid #e9ecef;
     padding: 12px 15px;
     font-size: 14px;
     transition: all 0.3s ease;
 }
 
 .form-control:focus, .form-select:focus {
     border-color: #2a5298;
     box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
 }
 
 .btn-primary {
     background: linear-gradient(135deg, #1e3c72, #2a5298);
     border: none;
     border-radius: 8px;
     padding: 12px 25px;
     font-weight: 600;
     transition: all 0.3s ease;
 }
 
 .btn-primary:hover {
     transform: translateY(-2px);
     box-shadow: 0 5px 15px rgba(42, 82, 152, 0.4);
 }
 
 .calculated-field {
     background-color: #e7f3ff;
     border-color: #bee5eb;
     font-weight: 600;
 }
 
 .supplier-row {
     background-color: #f8f9fa;
     border-radius: 10px;
     padding: 20px;
     margin-bottom: 15px;
     border: 1px solid #dee2e6;
 }
 
 .hidden-field {
     display: none;
 }
 
 .note-field {
     min-height: 60px;
     resize: vertical;
 }
 
 .revision-info {
     font-size: 12px;
     color: #6c757d;
     margin-top: 10px;
 }
 
 .destination-quantities {
     margin-top: 10px;
     padding: 10px;
     background-color: #f8f9fa;
     border: 1px solid #dee2e6;
     border-radius: 5px;
 }
 
 .destination-item {
     display: flex;
     align-items: center;
     margin-bottom: 8px;
 }
 
 .destination-item label {
     min-width: 120px;
     margin-right: 10px;
     font-size: 12px;
 }
 
 .destination-item input {
     width: 80px;
     padding: 4px 8px;
     font-size: 12px;
 }
 
 .addition-suppliers {
     margin-top: 10px;
     padding: 10px;
     background-color: #e8f5e8;
     border: 1px solid #28a745;
     border-radius: 5px;
 }
 
 .addition-detail {
     background-color: #e7f3ff;
     border: 1px solid #2a5298;
     border-radius: 5px;
     padding: 8px;
     margin-top: 10px;
     font-size: 12px;
 }
</style>
</head>
<body>
<div class="container-fluid">
 <!-- Header principale -->
 <div class="main-header">
     <h1><i class="bi bi-calendar-check"></i> PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
     <h4>Sistema di Gestione Produzione - Simone Gatto</h4>
     <p class="mb-0">Data: <span id="current-date"></span></p>
     <div class="revision-info">
         Ultima revisione: <span id="last-revision"></span>
     </div>
 </div>

 <!-- Sezione Selezione Tipo Agrume -->
 <div class="section-card">
     <h3 class="section-title"><i class="bi bi-gear-fill"></i> Tipo di Agrume</h3>
     <div class="row">
         <div class="col-md-6">
             <label for="tipo-agrume-giornaliero" class="form-label">Seleziona Tipo di Agrume</label>
             <select class="form-select" id="tipo-agrume-giornaliero" required>
                 <option value="">Seleziona il tipo di agrume</option>
                 <option value="LIMONE">Limone</option>
                 <option value="ARANCIA">Arancia</option>
                 <option value="MANDARINO">Mandarino</option>
                 <option value="POMPELMO">Pompelmo</option>
                 <option value="BERGAMOTTO">Bergamotto</option>
             </select>
         </div>
         <div class="col-md-6">
             <label for="data-lavorazione" class="form-label">Data Lavorazione</label>
             <input type="date" class="form-control" id="data-lavorazione" required>
         </div>
     </div>
 </div>

 <!-- Sezione Totali -->
 <div class="section-card">
     <h3 class="section-title"><i class="bi bi-boxes"></i> Quantità Totali</h3>
     <div class="row">
         <div class="col-md-4">
             <label for="entrata-giornaliera" class="form-label">Entrata Giornaliera Totale (kg)</label>
             <input type="number" class="form-control calculated-field" id="entrata-giornaliera" readonly>
         </div>
         <div class="col-md-4">
             <label for="trasformata-totale" class="form-label">Quantità trasformata Totale (kg)</label>
             <input type="number" class="form-control calculated-field" id="trasformata-totale" readonly>
         </div>
         <div class="col-md-4">
             <label for="giacenza-totale" class="form-label">Giacenza Totale (kg)</label>
             <input type="number" class="form-control calculated-field" id="giacenza-totale" readonly>
         </div>
     </div>
 </div>

 <!-- Sezione Fornitori -->
 <div class="section-card">
     <h3 class="section-title"><i class="bi bi-truck"></i> Dettagli Fornitori e Lavorazione</h3>
     <div class="alert alert-info">
         <i class="bi bi-info-circle"></i> Aggiungi i fornitori e configura i parametri di lavorazione per ciascuno.
     </div>
     
     <div id="fornitori-container">
         <!-- I fornitori verranno aggiunti dinamicamente qui -->
     </div>
     
     <button type="button" class="btn btn-primary" id="aggiungi-fornitore">
         <i class="bi bi-plus-circle"></i> Aggiungi Fornitore
     </button>
 </div>

 <!-- Pulsanti di azione -->
 <div class="section-card text-center">
     <button type="button" class="btn btn-outline-secondary btn-lg me-3" id="anteprima-stampa">
         <i class="bi bi-printer"></i> Anteprima Stampa
     </button>
     <button type="button" class="btn btn-outline-danger btn-lg" id="reset-programma">
         <i class="bi bi-arrow-clockwise"></i> Reset Programma
     </button>
 </div>
</div>

<!-- Template per fornitore -->
<div id="fornitore-template" class="hidden-field">
<div class="supplier-row" data-supplier-index="">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h5><i class="bi bi-building"></i> Fornitore <span class="supplier-number"></span></h5>
        <button type="button" class="btn btn-outline-danger btn-sm rimuovi-fornitore">
            <i class="bi bi-trash"></i> Rimuovi
        </button>
    </div>
    
    <div class="row g-3">
        <!-- Dati base fornitore -->
        <div class="col-md-3">
            <label class="form-label">Nome Fornitore</label>
            <select class="form-select nome-fornitore" required>
                <option value="">Seleziona fornitore</option>
                <option value="RESTUCCIA">RESTUCCIA</option>
                <option value="CI">CI</option>
                <option value="ARCO">ARCO</option>
                <option value="GIOVINAZZO">GIOVINAZZO</option>
                <option value="AZ.T.C.">AZ.T.C.</option>
                <option value="M.B.T.F.">M.B.T.F.</option>                  
                <option value="VASTA">VASTA</option>
                <option value="APAL">APAL</option> 
                <option value="GEIMA">GEIMA</option>
                <option value="UNIONBERG">UNIONBERG</option>                  
                <option value="ALTRO">ALTRO</option>
            </select>
            <input type="text" class="form-control mt-2 altro-fornitore hidden-field" placeholder="Specifica altro fornitore">
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Quantità in Entrata (kg)</label>
            <input type="number" class="form-control quantita-fornitore" min="0" required>
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Quantità trasformata (kg)</label>
            <input type="number" class="form-control quantita-trasformata" min="0" placeholder="0">
        </div>
        
        <div class="col-md-3">
            <label class="form-label">Giacenza (kg)</label>
            <input type="number" class="form-control calculated-field giacenza-fornitore" readonly>
        </div>
        
        <div class="col-md-4">
            <label class="form-label">Certificazione Prodotto</label>
            <select class="form-select certificazione-prodotto" required>
                <option value="">Seleziona certificazione</option>
                <option value="BIO EU">BIO EU</option>
                <option value="BIO DEM">BIO DEM</option>
                <option value="BIO NTD">BIO NTD</option>
                <option value="BIO DEM/NTD">BIO DEM/NTD</option>
                <option value="TRACCIATO">TRACCIATO</option>
                <option value="IGP">IGP</option>
                <option value="CONVENZIONALE">CONVENZIONALE</option>
                <option value="ALTRO">ALTRO</option>
            </select>
        </div>
        
        <div class="col-md-4">
            <label class="form-label">Varietà</label>
            <select class="form-select varieta-prodotto" required>
                <option value="">Seleziona varietà</option>
                <!-- Opzioni dinamiche in base al tipo di agrume -->
            </select>
        </div>
        
        <!-- Parametri lavorazione -->
        <div class="col-md-4">
            <label class="form-label">Linea di Trasformazione</label>
            <select class="form-select linea-trasformazione" required>
                <option value="">Seleziona linea</option>
                <option value="BOE/1100">BOE/1100</option>
                <option value="GOE INT/POLY">GOE INT/POLY</option>
                <option value="GOE EST/POLY">GOE EST/POLY</option>
                <option value="GOE EST/400">GOE EST/400</option>
                <option value="B/SF">B/SF</option>
                <option value="TORCHI FASO">TORCHI FASO</option>
            </select>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">Portata Impianto (kg/h)</label>
            <input type="number" class="form-control portata-impianto" min="100" max="5000" required>
        </div>
        
        <div class="col-md-6">
            <label class="form-label">Orario Inizio Lavorazione</label>
            <input type="time" class="form-control orario-inizio" required>
        </div>
    </div>
    
    <!-- Sezione Rese e Destinazioni -->
    <div class="mt-4">
        <h6><i class="bi bi-droplet"></i> Calcolo Rese e Destinazioni</h6>
        
        <div class="row g-3 mt-2">
            <!-- Rese percentuali -->
            <div class="col-md-4">
                <label class="form-label">Resa Succo 1ª (%)</label>
                <input type="number" class="form-control resa-prima" step="0.1" min="0" max="100" value="35">
            </div>
           
           <div class="col-md-4">
               <label class="form-label">Quantità Succo 1ª (kg)</label>
              <input type="number" class="form-control calculated-field quantita-prima" readonly>
              <!-- Sezione aggiunte da altri fornitori -->
              <div class="addition-detail hidden-field">
                  <strong>Aggiunte da altri fornitori:</strong>
                  <div class="addition-list"></div>
                  <div class="total-with-additions mt-2">
                      <strong>Totale con aggiunte: <span class="total-value">0</span> kg</strong>
                  </div>
              </div>
          </div>
      </div>
      
      <!-- Destinazioni spremiture -->
      <div class="row g-3 mt-3">
          <div class="col-md-6">
              <label class="form-label">Destinazione Succo 1ª</label>
              <select class="form-select destinazione-prima" multiple>
                  <option value="NAT IN TINI">NAT IN TINI</option>
                  <option value="PET 100">PET 100</option>
                  <option value="PET 200">PET 200</option>
                  <option value="PET 480">PET 480</option>
                  <option value="ACMA">ACMA</option>
                  <option value="REX">REX</option>
                  <option value="GOGLIO">GOGLIO</option>
                  <option value="VASCHETTE">VASCHETTE</option>
                  <option value="CONCENTRATO">CONCENTRATO</option>
                  <option value="ALTRO">ALTRO</option>
             </select>
             
             <!-- Sezione quantità per destinazioni multiple -->
             <div class="destination-quantities hidden-field mt-3">
                 <label class="form-label"><strong>Quantità per destinazione (kg):</strong></label>
                 <div class="destinations-list">
                     <!-- Gli input per le quantità verranno aggiunti dinamicamente -->
                 </div>
             </div>
             
             <!-- Sezione aggiunte a questo fornitore -->
             <div class="addition-suppliers mt-3">
                 <label class="form-label"><strong>Aggiungi a destinazione Succo 1ª:</strong></label>
                 <select class="form-select add-to-supplier mt-2">
                     <option value="">Seleziona fornitore di origine</option>
                     <!-- Opzioni dinamiche -->
                 </select>
                 <div class="row mt-2">
                     <div class="col-6">
                         <input type="number" class="form-control add-quantity" placeholder="Quantità (kg)" step="0.1" min="0">
                     </div>
                     <div class="col-6">
                         <button type="button" class="btn btn-success btn-sm add-supplier-quantity">
                             <i class="bi bi-plus"></i> Aggiungi
                         </button>
                     </div>
                 </div>
             </div>
         </div>
     </div>
     
     <!-- Note -->
     <div class="row g-3 mt-3">
         <div class="col-md-12">
             <label class="form-label">Note</label>
             <textarea class="form-control note-field note-prima" placeholder="Inserisci note per questo fornitore"></textarea>
         </div>
     </div>
 </div>
</div>
</div>

<script>
$(document).ready(function() {
    let supplierCount = 0;
    let supplierAdditions = {}; // {toSupplierIndex: [{fromSupplierIndex, quantity, fromSupplierName}]}
    
    // Inizializzazione data corrente
    function initCurrentDate() {
        const today = new Date();
        const formatted = today.toLocaleDateString('it-IT', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
        $('#current-date').text(formatted);
        $('#data-lavorazione').val(today.toISOString().split('T')[0]);
        updateLastRevision();
    }
    
    function updateLastRevision() {
        const now = new Date();
        const lastRevision = now.toLocaleDateString('it-IT') + ' - ' + now.toLocaleTimeString('it-IT');
        $('#last-revision').text(lastRevision);
    }
    
    // Aggiunta nuovo fornitore
    function addSupplier() {
        supplierCount++;
        const template = $('#fornitore-template').html();
        const newSupplier = $(template);
        
        newSupplier.attr('data-supplier-index', supplierCount);
        newSupplier.find('.supplier-number').text(supplierCount);
        
        $('#fornitori-container').append(newSupplier);
        
        // Inizializza Select2 per destinazione multipla
        newSupplier.find('.destinazione-prima').select2({
            placeholder: "Seleziona destinazioni",
            maximumSelectionLength: 3
        });
        
        attachSupplierEvents(newSupplier);
        updateAddSupplierOptions();
    }
    
    // Eventi per ogni fornitore
    function attachSupplierEvents(supplierElement) {
        // Gestione campo "ALTRO" per fornitore
        supplierElement.find('.nome-fornitore').change(function() {
            const altroField = supplierElement.find('.altro-fornitore');
            if ($(this).val() === 'ALTRO') {
                altroField.removeClass('hidden-field');
            } else {
                altroField.addClass('hidden-field').val('');
            }
            updateAddSupplierOptions();
        });
        
        // Gestione destinazioni multiple
        supplierElement.find('.destinazione-prima').on('change', function() {
            handleMultipleDestinations(supplierElement);
        });
        
        // Gestione aggiunte fornitori
        supplierElement.find('.add-supplier-quantity').click(function() {
            addSupplierQuantity(supplierElement);
        });
        
        // Calcoli automatici
        supplierElement.find('.quantita-fornitore, .quantita-trasformata, .resa-prima').on('input change', function() {
            calculateGiacenza(supplierElement);
            calculateYieldQuantities(supplierElement);
            updateTotals();
            updateAdditionsDisplay(supplierElement);
        });
        
        // Rimozione fornitore
        supplierElement.find('.rimuovi-fornitore').click(function() {
            if (confirm('Sei sicuro di voler rimuovere questo fornitore?')) {
                const supplierIndex = supplierElement.data('supplier-index');
                
                // Rimuovi aggiunte relative a questo fornitore
                delete supplierAdditions[supplierIndex];
                
                // Rimuovi aggiunte da questo fornitore verso altri
                Object.keys(supplierAdditions).forEach(toSupplierIndex => {
                    supplierAdditions[toSupplierIndex] = supplierAdditions[toSupplierIndex].filter(
                        addition => addition.fromSupplierIndex != supplierIndex
                    );
                    if (supplierAdditions[toSupplierIndex].length === 0) {
                        delete supplierAdditions[toSupplierIndex];
                    }
                });
                
                supplierElement.remove();
                updateTotals();
                updateAddSupplierOptions();
                
                // Aggiorna display aggiunte per tutti i fornitori rimasti
                $('.supplier-row').each(function() {
                    updateAdditionsDisplay($(this));
                });
            }
        });
    }
    
    // Aggiorna select per aggiunte fornitori
    function updateAddSupplierOptions() {
        $('.add-to-supplier').each(function() {
            const currentSupplierIndex = $(this).closest('.supplier-row').data('supplier-index');
            const select = $(this);
            
            select.empty();
            select.append('<option value="">Seleziona fornitore di origine</option>');
            
            $('.supplier-row').each(function() {
                const supplierIndex = $(this).data('supplier-index');
                if (supplierIndex !== currentSupplierIndex) {
                    const fornitore = $(this).find('.nome-fornitore').val() || '';
                    const altroFornitore = $(this).find('.altro-fornitore').val();
                    const nomeFornitore = fornitore === 'ALTRO' ? altroFornitore : fornitore;
                    
                    if (nomeFornitore) {
                        select.append(`<option value="${supplierIndex}">F${supplierIndex} - ${nomeFornitore}</option>`);
                    }
                }
            });
        });
    }
    
    // Gestione destinazioni multiple e quantità
    function handleMultipleDestinations(supplierElement) {
        const selectedDestinations = supplierElement.find('.destinazione-prima').val() || [];
        const quantitiesContainer = supplierElement.find('.destination-quantities');
        const destinationsList = quantitiesContainer.find('.destinations-list');
        
        if (selectedDestinations.length > 1) {
            quantitiesContainer.removeClass('hidden-field');
            destinationsList.empty();
            
            selectedDestinations.forEach(dest => {
                if (dest !== 'ALTRO') {
                    const destItem = $(`
                        <div class="destination-item">
                            <label>${dest}:</label>
                            <input type="number" class="form-control dest-quantity" data-destination="${dest}" 
                                   placeholder="0" step="0.1" min="0">
                            <span class="ms-2">kg</span>
                        </div>
                    `);
                    destinationsList.append(destItem);
                }
            });
        } else {
            quantitiesContainer.addClass('hidden-field');
        }
    }
    
    // Aggiungi quantità da un fornitore a un altro
    function addSupplierQuantity(toSupplierElement) {
        const toSupplierIndex = toSupplierElement.data('supplier-index');
        const fromSupplierIndex = toSupplierElement.find('.add-to-supplier').val();
        const quantity = parseFloat(toSupplierElement.find('.add-quantity').val()) || 0;
        
        if (!fromSupplierIndex || quantity <= 0) {
            alert('Seleziona un fornitore di origine e inserisci una quantità valida');
            return;
        }
        
        const fromSupplierElement = $(`[data-supplier-index="${fromSupplierIndex}"]`);
        const fromSupplierName = getSupplierDisplayName(fromSupplierElement);
        
        // Inizializza array se non esiste
        if (!supplierAdditions[toSupplierIndex]) {
            supplierAdditions[toSupplierIndex] = [];
        }
        
        // Aggiungi l'aggiunta
        supplierAdditions[toSupplierIndex].push({
            fromSupplierIndex: fromSupplierIndex,
            fromSupplierName: fromSupplierName,
            quantity: quantity
        });
        
        // Reset campi
        toSupplierElement.find('.add-to-supplier').val('');
        toSupplierElement.find('.add-quantity').val('');
        
        // Aggiorna display
        updateAdditionsDisplay(toSupplierElement);
        
        alert(`Aggiunta ${quantity} kg da ${fromSupplierName} a F${toSupplierIndex}`);
    }
    
    // Ottieni nome visualizzabile del fornitore
    function getSupplierDisplayName(supplierElement) {
        const fornitore = supplierElement.find('.nome-fornitore').val() || '';
        const altroFornitore = supplierElement.find('.altro-fornitore').val();
        return fornitore === 'ALTRO' ? altroFornitore : fornitore;
    }
    
    // Aggiorna display delle aggiunte
    function updateAdditionsDisplay(supplierElement) {
        const supplierIndex = supplierElement.data('supplier-index');
        const additions = supplierAdditions[supplierIndex] || [];
        const additionDetail = supplierElement.find('.addition-detail');
        const additionList = additionDetail.find('.addition-list');
        const totalValue = additionDetail.find('.total-value');
        
        if (additions.length > 0) {
            additionDetail.removeClass('hidden-field');
            additionList.empty();
            
            let additionsTotal = 0;
            additions.forEach((addition, index) => {
                additionsTotal += addition.quantity;
                const additionItem = $(`
                    <div class="addition-item d-flex justify-content-between align-items-center mb-1">
                        <span>F${addition.fromSupplierIndex} (${addition.fromSupplierName}): ${addition.quantity} kg</span>
                        <button type="button" class="btn btn-outline-danger btn-sm remove-addition" data-index="${index}">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                `);
                additionList.append(additionItem);
            });
            
            // Calcola totale con quantità base
            const baseQuantity = parseFloat(supplierElement.find('.quantita-prima').val()) || 0;
            const totalWithAdditions = baseQuantity + additionsTotal;
            totalValue.text(totalWithAdditions.toFixed(1));
            
            // Eventi per rimozione
            additionList.find('.remove-addition').click(function() {
                const indexToRemove = parseInt($(this).data('index'));
                supplierAdditions[supplierIndex].splice(indexToRemove, 1);
                updateAdditionsDisplay(supplierElement);
            });
        } else {
            additionDetail.addClass('hidden-field');
        }
    }
    
    // Calcolo giacenza per fornitore (Entrata - Trasformata)
    function calculateGiacenza(supplierElement) {
        const quantitaEntrata = parseFloat(supplierElement.find('.quantita-fornitore').val()) || 0;
        const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
        const giacenza = quantitaEntrata - quantitaTrasformata;
        
        supplierElement.find('.giacenza-fornitore').val(giacenza >= 0 ? giacenza : 0);
    }
    
    // Calcolo quantità prodotti in base alle rese
    function calculateYieldQuantities(supplierElement) {
        const quantitaTrasformata = parseFloat(supplierElement.find('.quantita-trasformata').val()) || 0;
        const resaPrima = parseFloat(supplierElement.find('.resa-prima').val()) || 0;
        
        if (quantitaTrasformata > 0) {
            const quantitaPrima = (quantitaTrasformata * resaPrima / 100).toFixed(1);
            supplierElement.find('.quantita-prima').val(quantitaPrima);
        } else {
            supplierElement.find('.quantita-prima').val('');
        }
    }
    
    // Aggiornamento totali
    function updateTotals() {
        let totaleEntrata = 0;
        let totaleTrasformata = 0;
        let totaleGiacenza = 0;
     $('.supplier-row').each(function() {
           const entrata = parseFloat($(this).find('.quantita-fornitore').val()) || 0;
           const trasformata = parseFloat($(this).find('.quantita-trasformata').val()) || 0;
           const giacenza = parseFloat($(this).find('.giacenza-fornitore').val()) || 0;
           
           totaleEntrata += entrata;
           totaleTrasformata += trasformata;
           totaleGiacenza += giacenza;
       });
       
       $('#entrata-giornaliera').val(totaleEntrata);
       $('#trasformata-totale').val(totaleTrasformata);
       $('#giacenza-totale').val(totaleGiacenza);
   }
   
   // Raccolta dati programma
   function collectProgramData() {
       const data = {
           tipoAgrume: $('#tipo-agrume-giornaliero').val(),
           dataLavorazione: $('#data-lavorazione').val(),
           entrataGiornaliera: parseFloat($('#entrata-giornaliera').val()) || 0,
           trasformataTotale: parseFloat($('#trasformata-totale').val()) || 0,
           giacenzaTotale: parseFloat($('#giacenza-totale').val()) || 0,
           ultimaRevisione: $('#last-revision').text(),
           supplierAdditions: supplierAdditions,
           fornitori: []
       };
       
       $('.supplier-row').each(function() {
           const destinazioniPrima = $(this).find('.destinazione-prima').val() || [];
           const supplierIndex = parseInt($(this).data('supplier-index'));
           
           // Raccogli quantità per destinazioni multiple
           const destinationQuantities = {};
           $(this).find('.dest-quantity').each(function() {
               const dest = $(this).data('destination');
               const qty = parseFloat($(this).val()) || 0;
               if (qty > 0) {
                   destinationQuantities[dest] = qty;
               }
           });
           
           const fornitore = {
               supplierIndex: supplierIndex,
               nome: $(this).find('.nome-fornitore').val(),
               altroNome: $(this).find('.altro-fornitore').val(),
               quantitaEntrata: parseFloat($(this).find('.quantita-fornitore').val()) || 0,
               quantitaTrasformata: parseFloat($(this).find('.quantita-trasformata').val()) || 0,
               giacenza: parseFloat($(this).find('.giacenza-fornitore').val()) || 0,
               certificazione: $(this).find('.certificazione-prodotto').val(),
               varieta: $(this).find('.varieta-prodotto').val(),
               lineaTrasformazione: $(this).find('.linea-trasformazione').val(),
               portataImpianto: parseFloat($(this).find('.portata-impianto').val()) || 0,
               orarioInizio: $(this).find('.orario-inizio').val(),
               rese: {
                   prima: parseFloat($(this).find('.resa-prima').val()) || 0
               },
               quantitaProdotti: {
                   prima: parseFloat($(this).find('.quantita-prima').val()) || 0
               },
               destinazioni: {
                   prima: destinazioniPrima.join(', ')
               },
               destinationQuantities: destinationQuantities,
               note: $(this).find('.note-prima').val()
           };
           
           data.fornitori.push(fornitore);
       });
       
       return data;
   }
   
   // Generazione anteprima stampa
   function generatePrintPreview(data) {
       const printWindow = window.open('', '_blank');
       
       let printContent = `
           <!DOCTYPE html>
           <html>
           <head>
               <title>Programma Giornaliero - ${data.dataLavorazione}</title>
               <style>
                   * {
                       margin: 0;
                       padding: 0;
                       box-sizing: border-box;
                   }
                   
                   body { 
                       font-family: 'Arial', sans-serif;
                       font-size: 10px;
                       line-height: 1.2;
                       color: #333;
                       margin: 10px;
                   }
                   
                   .header {
                       text-align: center;
                       margin-bottom: 15px;
                       border-bottom: 2px solid #1e3c72;
                       padding-bottom: 8px;
                   }
                   
                   .header h1 {
                       font-size: 16px;
                       color: #1e3c72;
                       margin-bottom: 5px;
                   }
                   
                   .header-info {
                       display: flex;
                       justify-content: space-around;
                       margin-top: 8px;
                       font-size: 9px;
                   }
                   
                   .totals-grid {
                       display: grid;
                       grid-template-columns: repeat(3, 1fr);
                       gap: 8px;
                       margin-bottom: 15px;
                   }
                   
                   .total-item {
                       text-align: center;
                       padding: 8px;
                       background-color: #e7f3ff;
                       border: 1px solid #2a5298;
                       border-radius: 5px;
                   }
                   
                   .total-value {
                       font-size: 12px;
                       font-weight: bold;
                       color: #1e3c72;
                   }
                   
                   .total-label {
                       font-size: 8px;
                       color: #666;
                   }
                   
                   .suppliers-grid {
                       display: grid;
                       grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                       gap: 10px;
                       margin-bottom: 15px;
                   }
                   
                   .supplier-column {
                       border: 2px solid #1e3c72;
                       border-radius: 8px;
                       page-break-inside: avoid;
                       background-color: #f8f9fa;
                       min-height: 200px;
                   }
                   
                   .supplier-header {
                       background-color: #1e3c72;
                       color: white;
                       padding: 8px;
                       text-align: center;
                       font-weight: bold;
                       font-size: 12px;
                   }
                   
                   .supplier-content {
                       padding: 10px;
                   }
                   
                   .info-section {
                       margin-bottom: 8px;
                       padding: 6px;
                       border-radius: 4px;
                   }
                   
                   .fruit-info {
                       background-color: #e8f5e8;
                       border-left: 3px solid #28a745;
                   }
                   
                   .processing-info {
                       background-color: #fff3cd;
                       border-left: 3px solid #ffc107;
                   }
                   
                   .products-info {
                       background-color: #f8d7da;
                       border-left: 3px solid #dc3545;
                   }
                   
                   .notes-info {
                       background-color: #f0f8ff;
                       border-left: 3px solid #007bff;
                       margin-top: 6px;
                   }
                   
                   .additions-info {
                       background-color: #e8f5e8;
                       border-left: 3px solid #28a745;
                       margin-top: 6px;
                   }
                   
                   .info-label {
                       font-weight: bold;
                       font-size: 8px;
                       color: #666;
                       text-transform: uppercase;
                       margin-bottom: 2px;
                   }
                   
                   .info-value {
                       font-size: 10px;
                       word-wrap: break-word;
                   }
                   
                   .highlighted-value {
                       font-weight: bold;
                       color: #1e3c72;
                       font-size: 11px;
                   }
                   
                   .footer {
                       text-align: center;
                       margin-top: 15px;
                       font-size: 8px;
                       color: #666;
                       border-top: 1px solid #ddd;
                       padding-top: 8px;
                   }
                   
                   @media print {
                       body { margin: 8px; }
                       .suppliers-grid {
                           grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
                       }
                   }
               </style>
           </head>
           <body>
               <div class="header">
                   <h1>PROGRAMMA GIORNALIERO TRASFORMAZIONE FRUTTA</h1>
                   <div>Sistema di Gestione Produzione - Simone Gatto</div>
                   <div class="header-info">
                       <div><strong>Data:</strong> ${data.dataLavorazione ? new Date(data.dataLavorazione).toLocaleDateString('it-IT') : 'N/D'}</div>
                       <div><strong>Agrume:</strong> ${data.tipoAgrume || 'N/D'}</div>
                       <div><strong>Fornitori:</strong> ${data.fornitori.length}</div>
                       <div><strong>Generato:</strong> ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT')}</div>
                   </div>
               </div>
               
               <div class="totals-grid">
                   <div class="total-item">
                       <div class="total-value">${data.entrataGiornaliera.toLocaleString()}</div>
                       <div class="total-label">Kg Entrata Totale</div>
                   </div>
                   <div class="total-item">
                       <div class="total-value">${data.trasformataTotale.toLocaleString()}</div>
                       <div class="total-label">Kg Trasformati</div>
                   </div>
                   <div class="total-item">
                       <div class="total-value">${data.giacenzaTotale.toLocaleString()}</div>
                       <div class="total-label">Kg Giacenza</div>
                   </div>
               </div>

               <div class="suppliers-grid">
       `;
       
       // Genera colonne fornitori nell'ordine corretto
       const orderedSuppliers = [];
       for (let i = 1; i <= data.fornitori.length; i++) {
           const supplier = data.fornitori.find(f => f.supplierIndex === i);
           if (supplier) {
               orderedSuppliers.push(supplier);
           }
       }
       
       orderedSuppliers.forEach(fornitore => {
           printContent += generateSupplierColumn(fornitore, data.supplierAdditions);
       });
       
       printContent += `
               </div>
               
               <div class="footer">
                   <p>Documento generato automaticamente - Sistema di Gestione Produzione Simone Gatto</p>
                   <p>Ultima revisione: ${data.ultimaRevisione}</p>
               </div>
           </body>
           </html>
       `;
       
       printWindow.document.write(printContent);
       printWindow.document.close();
       printWindow.focus();
   }
   
   // Funzione per generare una singola colonna fornitore
   function generateSupplierColumn(fornitore, supplierAdditions) {
       const nomeFornitore = fornitore.nome === 'ALTRO' ? fornitore.altroNome : fornitore.nome;
       const nomeVarieta = fornitore.varieta || 'N/D';
       
       // Gestione destinazioni
       let destPrima = fornitore.destinazioni.prima || 'N/D';
       destPrima = destPrima.split(', ').map(d => 
           d.replace('CONCENTRATO', 'CONC').replace('NAT IN TINI', 'TINI')
       ).join(', ');
       
       // Gestione quantità destinazioni se ci sono multiple destinazioni
       let destinationDetails = '';
       if (fornitore.destinationQuantities && Object.keys(fornitore.destinationQuantities).length > 0) {
           const destEntries = Object.entries(fornitore.destinationQuantities).map(([dest, qty]) => 
               `${dest}: ${qty}kg`
           );
           destinationDetails = `<div style="font-size: 8px; margin-top: 3px; color: #666;"><strong>Dettaglio quantità:</strong> ${destEntries.join(', ')}</div>`;
       }
       
       // Note complete
       let noteContent = '';
       if (fornitore.note && fornitore.note.trim()) {
           noteContent = `
               <div class="info-section notes-info">
                   <div class="info-label">Note</div>
                   <div class="info-value" style="font-size: 9px;">${fornitore.note}</div>
               </div>
           `;
       }
       
       // Gestione aggiunte da altri fornitori
       let additionsContent = '';
       const additions = supplierAdditions && supplierAdditions[fornitore.supplierIndex] ? supplierAdditions[fornitore.supplierIndex] : [];
       if (additions.length > 0) {
           const baseQuantity = fornitore.quantitaProdotti.prima || 0;
           const additionsTotal = additions.reduce((total, addition) => total + addition.quantity, 0);
           const totalWithAdditions = baseQuantity + additionsTotal;
           
           const additionsList = additions.map(addition => 
               `F${addition.fromSupplierIndex} (${addition.fromSupplierName}): +${addition.quantity}kg`
           ).join(', ');
           
           additionsContent = `
               <div class="info-section additions-info">
                   <div class="info-label">Aggiunte da altri fornitori</div>
                   <div class="info-value" style="font-size: 8px;">${additionsList}</div>
                   <div class="info-value highlighted-value" style="margin-top: 3px;">Totale con aggiunte: ${totalWithAdditions.toFixed(1)} kg</div>
               </div>
           `;
       }
       
       return `
           <div class="supplier-column">
               <div class="supplier-header">F${fornitore.supplierIndex} - ${nomeFornitore || 'N/D'}</div>
               <div class="supplier-content">
                   <!-- Informazioni Frutta in Ingresso -->
                   <div class="info-section fruit-info">
                       <div class="info-label">Quantità Ingresso</div>
                       <div class="info-value highlighted-value">${fornitore.quantitaEntrata} kg</div>
                       
                       <div class="info-label" style="margin-top: 4px;">Da Trasformare</div>
                       <div class="info-value highlighted-value">${fornitore.quantitaTrasformata} kg</div>
                       
                       <div class="info-label" style="margin-top: 4px;">Rimanenza</div>
                       <div class="info-value highlighted-value">${fornitore.giacenza} kg</div>
                       
                       <div class="info-label" style="margin-top: 4px;">Certificazione</div>
                       <div class="info-value">${fornitore.certificazione || 'N/D'}</div>
                       
                       <div class="info-label" style="margin-top: 4px;">Varietà</div>
                       <div class="info-value">${nomeVarieta}</div>
                   </div>
                   
                   <!-- Linea di Trasformazione -->
                   <div class="info-section processing-info">
                       <div class="info-label">Linea Trasformazione</div>
                       <div class="info-value highlighted-value">${fornitore.lineaTrasformazione || 'N/D'}</div>
                       
                       <div class="info-label" style="margin-top: 4px;">Orario Inizio</div>
                       <div class="info-value">${fornitore.orarioInizio || '-'}</div>
                       
                       <div class="info-label" style="margin-top: 4px;">Portata</div>
                       <div class="info-value">${fornitore.portataImpianto} kg/h</div>
                   </div>
                   
                   <!-- Informazioni Prodotti -->
                   <div class="info-section products-info">
                       <div class="info-label">Succo 1ª</div>
                       <div class="info-value highlighted-value">${fornitore.quantitaProdotti.prima} kg</div>
                       
                       <div class="info-label" style="margin-top: 4px;">Resa %</div>
                       <div class="info-value">${fornitore.rese.prima}%</div>
                       
                       <div class="info-label" style="margin-top: 4px;">Destinazione</div>
                       <div class="info-value" style="font-size: 9px;">${destPrima}</div>
                       ${destinationDetails}
                   </div>
                   
                   ${noteContent}
                   ${additionsContent}
               </div>
           </div>
       `;
   }
   
   // Eventi principali
   $('#aggiungi-fornitore').click(function() {
       if (!$('#tipo-agrume-giornaliero').val()) {
           alert('Seleziona prima il tipo di agrume');
           return;
       }
       addSupplier();
   });
   
   // Anteprima stampa
   $('#anteprima-stampa').click(function() {
       const programData = collectProgramData();
       generatePrintPreview(programData);
   });
   
   // Reset programma
   $('#reset-programma').click(function() {
       if (confirm('Attenzione: questa operazione cancellerà tutti i dati inseriti. Continuare?')) {
           location.reload();
       }
   });
   
   // Inizializzazione
   initCurrentDate();
   
   console.log('Sistema Programma Giornaliero Trasformazione inizializzato con successo');
});
</script>
</body>
</html>
